<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VRM Wareneingang – Kamera-OCR</title>
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="manifest.json?v=7" />
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --muted:#9fb0d0; --ok:#23c55e; --warn:#f59e0b; --err:#ef4444; --txt:#e6eefc; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{padding:14px 16px;border-bottom:1px solid #1c2740;display:flex;justify-content:space-between;align-items:center}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#0f1729;border:1px solid #1c2740;color:var(--muted)}
    main{padding:16px;max-width:1200px;margin:0 auto;display:grid;gap:16px}
    .card{background:#121a2b;border:1px solid #1c2740;border-radius:14px;padding:14px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    input[type="file"],select,button{background:#0f1729;color:var(--txt);border:1px solid #1c2740;border-radius:10px;padding:10px 12px}
    button{cursor:pointer} .primary{background:linear-gradient(180deg,#2563eb,#1d4ed8);border:none}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    video{width:100%;max-height:48vh;border-radius:12px;border:1px solid #1c2740;background:#0f1729}
    table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid #1c2740;padding:8px;text-align:left}
    th{background:#0f1729;position:sticky;top:0;z-index:1}
    td.c{text-align:center}
    #feedback.ok{color:var(--ok)} #feedback.warn{color:var(--warn)} #feedback.err{color:var(--err)}
    .status-erfasst{color:var(--warn);font-weight:600}
    pre#log{white-space:pre-wrap;background:#0f1729;border:1px solid #1c2740;border-radius:10px;padding:10px;max-height:22vh;overflow:auto}
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0;font-size:18px">VRM Wareneingang – Kamera-OCR</h1>
    <span class="badge">Build v7</span>
  </header>

  <main>
    <!-- 1) CSV LADEN -->
    <section class="card">
      <div class="row">
        <input id="file" type="file" accept=".csv,text/csv" />
        <button id="btnLoad" class="primary">CSV übernehmen</button>
        <select id="keyCol" disabled></select>
        <select id="qtyCol" disabled></select>
        <select id="lang">
          <option value="eng">OCR: Englisch</option>
          <option value="deu">OCR: Deutsch</option>
          <option value="eng+deu" selected>OCR: Englisch+Deutsch</option>
        </select>
        <button id="export" class="primary">Bericht exportieren</button>
      </div>
      <div class="hint">Beste Ergebnisse mit Schlüssel <b>Wagennummer</b> oder <b>LS</b> vom Aufkleber.</div>
    </section>

    <!-- 2) KAMERA & OCR -->
    <section class="card">
      <div class="row">
        <button id="startCam" class="primary">Kamera starten</button>
        <button id="stopCam">Kamera stoppen</button>
        <button id="scanNow" class="primary">Jetzt scannen</button>
        <label style="margin-left:10px"><input type="checkbox" id="beep" checked> Beep</label>
      </div>

      <div style="margin-top:10px" class="row">
        <div style="flex:1">
          <div class="hint">Letzter Scan:</div>
          <div id="lastScan" style="font-weight:700;font-size:16px">–</div>
          <div id="feedback"></div>
          <div id="statusbar" class="hint">Bereit.</div>
        </div>
      </div>

      <video id="video" autoplay playsinline></video>
      <div class="hint" id="ocrStatus">OCR bereit …</div>
    </section>

    <!-- 3) TABELLE -->
    <section class="card">
      <table>
        <thead>
          <tr>
            <th>Schlüssel</th>
            <th>Artikel</th>
            <th class="c">Erwartet</th>
            <th class="c">Gesc.</th>
            <th class="c">Offen</th>
            <th class="c">Status</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <!-- 4) LOG -->
    <section class="card">
      <div class="hint">Konsole</div>
      <pre id="log"></pre>
    </section>
  </main>

<script>
const $ = s=>document.querySelector(s);
const log = (...a)=>{$('#log').textContent += a.join(' ')+'\n'; console.log(...a)};

let headers=[], rows=[];
let expect=new Map(), scanned=new Map(), firstArticle=new Map();
let keyName='LS', qtyName='Bretter';
let videoStream=null, workerReady=false, ocrLang='eng+deu';

$('#btnLoad').addEventListener('click', async () => {
  const file = $('#file').files[0];
  if (!file) return alert('Bitte CSV auswählen.');
  const text = await file.text();
  const delim = detectDelimiter(text);
  const data = parseCSV(text, delim);
  if (!data.length) return alert('CSV leer.');
  headers = data[0].map(h => h.trim());
  rows = data.slice(1);
  log('CSV übernommen.');

  const keySel=$('#keyCol'), qtySel=$('#qtyCol');
  keySel.innerHTML=''; qtySel.innerHTML='';
  headers.forEach(h=>{
    let o1=document.createElement('option'); o1.value=h; o1.textContent=h; keySel.appendChild(o1);
    let o2=document.createElement('option'); o2.value=h; o2.textContent=h; qtySel.appendChild(o2);
  });
  keyName = headers.includes('LS') ? 'LS' : headers[0];
  keySel.value=keyName;
  qtyName = headers.includes('Bretter') ? 'Bretter' : '<keine>';
  qtySel.value=qtyName;
  keySel.disabled=false; qtySel.disabled=false;
  applyMapping();
});

$('#keyCol').addEventListener('change', e=>{keyName=e.target.value;applyMapping()});
$('#qtyCol').addEventListener('change', e=>{qtyName=e.target.value;applyMapping()});

function applyMapping(){
  expect.clear(); scanned.clear(); firstArticle.clear();
  const kIdx=headers.indexOf(keyName);
  const qIdx=(qtyName && qtyName!=='<keine>')?headers.indexOf(qtyName):-1;
  const aIdx=headers.indexOf('Artikelname');

  for (const r of rows){
    if (kIdx<0) continue;
    const key=String(r[kIdx]||'').trim();
    if (!key) continue;
    let q=1;
    if (qIdx>=0) q=toInt(r[qIdx],1);
    expect.set(key,(expect.get(key)||0)+(q>0?q:1));
    if (!firstArticle.has(key) && aIdx>=0) firstArticle.set(key,String(r[aIdx]||''));
  }
  renderTable();
}

function renderTable(){
  const tb=$('#tbody'); tb.innerHTML='';
  const keys=Array.from(expect.keys()).sort();
  for (const k of keys){
    const exp=expect.get(k)||0, done=scanned.get(k)||0, open=Math.max(exp-done,0);
    let status='offen', cls='';
    if (done===0) status='offen';
    else if (done<exp){status='erfasst'; cls='status-erfasst'}
    else if (done===exp){status='ok'; cls='ok'}
    else {status='überzählig'; cls='warn'}
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${k}</td><td>${firstArticle.get(k)||''}</td><td class="c">${exp}</td><td class="c">${done}</td><td class="c">${open}</td><td class="c ${cls}">${status}</td>`;
    tb.appendChild(tr);
  }
}

$('#export').addEventListener('click', ()=>{
  if (!expect.size) return alert('Kein Datensatz.');
  const out=[["Schlüssel","Artikel","Erwartet","Gesc.","Offen","Status"]];
  const keys=Array.from(expect.keys()).sort();
  for (const k of keys){
    const exp=expect.get(k)||0, done=scanned.get(k)||0, open=Math.max(exp-done,0);
    let s='offen'; if(done===0)s='offen'; else if(done<exp)s='erfasst'; else if(done===exp)s='ok'; else s='überzählig';
    out.push([k,firstArticle.get(k)||"",exp,done,open,s]);
  }
  downloadCSV('report.csv', out);
});

$('#lang').addEventListener('change', e=>{ocrLang=e.target.value});

$('#startCam').addEventListener('click', startCamera);
$('#stopCam').addEventListener('click', stopCamera);
$('#scanNow').addEventListener('click', ()=>{ const v=$('#video'); if (v.srcObject) captureAndOCR(v) });

async function startCamera(){
  try{
    const v=$('#video');
    videoStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    v.srcObject=videoStream;
    await ensureWorker();
    log('Kamera gestartet.');
  }catch(e){ log('Kamera-Fehler:', e.message) }
}

function stopCamera(){
  if (videoStream){ for (const t of videoStream.getTracks()) t.stop(); videoStream=null; }
  log('Kamera gestoppt.');
}

async function ensureWorker(){
  if (workerReady) return;
  if (!window.Tesseract){
    await new Promise((res,rej)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
      s.onload=res; s.onerror=rej;
      document.head.appendChild(s);
    });
  }
  window._tessWorker=window._tessWorker||await Tesseract.createWorker();
  await _tessWorker.loadLanguage(ocrLang);
  await _tessWorker.initialize(ocrLang);
  workerReady=true;
}

async function captureAndOCR(video){
  if (!workerReady) return;
  const c=document.createElement('canvas');
  const w=video.videoWidth,h=video.videoHeight;
  if(!w||!h) return;
  c.width=w; c.height=h;
  const ctx=c.getContext('2d');
  ctx.drawImage(video,0,0,w,h);
  const {data:{text}}=await _tessWorker.recognize(c);
  checkOCRMatch(text.trim());
}

function checkOCRMatch(text){
  const tokens=(text||'').toUpperCase().replace(/[^A-Z0-9]+/g,' ').split(' ').filter(t=>t.length>=4 && t.length<=12);
  const keyMap=new Map(); for(const key of expect.keys()) keyMap.set(String(key).toUpperCase(), key);

  for (const tok of tokens){
    if (keyMap.has(tok)){
      const key=keyMap.get(tok);
      scanned.set(key,(scanned.get(key)||0)+1);
      $('#lastScan').textContent=key;
      renderTable();
      return;
    }
  }
}

/* Utils */
function detectDelimiter(text){const counts={',':0,';':0,'\t':0,'|':0};let inQ=false;for(let ch of text.split('').slice(0,2000)){if(ch==='"')inQ=!inQ;else if(!inQ&&counts.hasOwnProperty(ch))counts[ch]++}return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0]}
function parseCSV(t,d){const r=[];let f='',row=[],q=false;for(let i=0;i<t.length;i++){const c=t[i];if(q){if(c==='"'){if(t[i+1]==='"'){f+='"';i++;continue}q=false}else f+=c}else{if(c==='"'){q=true}else if(c===d){row.push(f);f=''}else if(c==='\n'){row.push(f);r.push(row);f='';row=[]}else if(c!=='\r'){f+=c}}}row.push(f);r.push(row);return r}
function toInt(v,d=0){const n=parseFloat(String(v).replace(',','.'));return isNaN(n)?d:Math.round(n)}
function downloadCSV(name,rows){const csv=rows.map(r=>r.join(';')).join('\n');const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click()}
</script>
</body>
</html>
